%% 目標位置を求める関数
%rx(i,j)がiから見たjの相対位置　ddが目標の相対距離　dx(i),dy(i)がエージェントiのローカル座標系における目標位置

function [dx,dy]=dxdy(dx,dy,rx,ry,dd,sgn,N,phi)

dx(2)=rx(2,1)+cos(phi(2))*dd(2,1);
dy(2)=ry(2,1)-sin(phi(2))*dd(2,1);

 for i=2:N-1 %i+1が子．その隣接する点は１とi
        % 隣接点が同じ位置
        if sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)==0    
            dx(i+1)=rx(i+1,1)+dd(i+1,1);
            dy(i+1)=ry(i+1,1);
        end
        
        % 隣接点が近すぎる
        if sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)<abs(dd(i+1,i)-dd(i+1,1))
            dx(i+1)=rx(i+1,1)-dd(i+1,1)*(rx(i+1,i)-rx(i+1,1))/sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2);
            dy(i+1)=ry(i+1,1)-dd(i+1,1)*(ry(i+1,i)-ry(i+1,1))/sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2);
        end
        
        % 好位置
         if abs(dd(i+1,i)-dd(i+1,1))<=sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)&&sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)<=abs(dd(i+1,i)+dd(i+1,1))
             ctheta=(dd(i+1,1)^2+((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)-dd(i+1,i)^2)/(2*dd(i+1,1)*sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2));
             stheta=sqrt(1-ctheta^2);
             R=[ctheta sgn*stheta; -sgn*stheta ctheta];
             dx(i+1)=rx(i+1,1)+(R(1,1)*(rx(i+1,i)-rx(i+1,1))+R(1,2)*(ry(i+1,i)-ry(i+1,1)))*dd(i+1,1)/(sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2));
             dy(i+1)=ry(i+1,1)+(R(2,1)*(rx(i+1,i)-rx(i+1,1))+R(2,2)*(ry(i+1,i)-ry(i+1,1)))*dd(i+1,1)/(sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2));
         end
         
        % 隣接点が遠すぎる
         if abs(dd(i+1,i)+dd(i+1,1))<sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2)
             dx(i+1)=rx(i+1,1)+dd(i+1,1)*(rx(i+1,i)-rx(i+1,1))/(sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2));
             dy(i+1)=ry(i+1,1)+dd(i+1,1)*(ry(i+1,i)-ry(i+1,1))/(sqrt((rx(i+1,1)-rx(i+1,i))^2+(ry(i+1,1)-ry(i+1,i))^2));
         end
 end
end